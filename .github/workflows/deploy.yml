name: CI/CD Pipeline - Servidor C

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4
    
    - name: Verificar código C
      run: |
        echo "Verificando sintaxis del código C..."
        gcc -fsyntax-only server.c
        echo "Código verificado correctamente"
    
    - name: Compilar aplicación
      run: |
        echo "Compilando servidor..."
        gcc -o server server.c -Wall -Wextra
        echo "Compilación exitosa"
    
    - name: Probar ejecución
      run: |
        echo "Verificando que el binario es ejecutable..."
        file server
        ldd server || true
    
    - name: Login a GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Construir y publicar imagen Docker
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: |
          ghcr.io/${{ github.repository_owner }}/servidor-c-cicd:latest
          ghcr.io/${{ github.repository_owner }}/servidor-c-cicd:${{ github.sha }}
    
    - name: Resumen del despliegue
      run: |
        echo "Imagen publicada exitosamente"
        echo "Puedes descargarla con:"
        echo "docker pull ghcr.io/${{ github.repository_owner }}/servidor-c-cicd:latest"